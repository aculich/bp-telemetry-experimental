# Cursor Markdown Writer - Implementation Summary

## Overview

This module implements Python functionality similar to the example extension (`docs/example_cursor_capture/`) that:
1. Watches Cursor database files for changes
2. Queries all trace-relevant ItemTable keys
3. Generates markdown files similar to the example extension
4. Writes to `.history/` directory

## Components

### 1. `markdown_writer.py`

**`CursorMarkdownWriter`** class that:
- Queries ItemTable for all trace-relevant keys (same as example extension)
- Formats data into markdown sections:
  - Composer sessions (`composer.composerData`)
  - AI service generations (`aiService.generations`)
  - Prompts (`aiService.prompts`)
  - Background composer (`workbench.backgroundComposer.workspacePersistentData`)
  - Agent mode (`workbench.agentMode.exitInfo`)
  - File history (`history.entries`)
- Writes markdown files with timestamps

**Key Methods:**
- `write_from_database(db_path, workspace_hash)` - Main entry point
- `_load_database_data(db_path)` - Queries all TRACE_RELEVANT_KEYS
- `_generate_markdown(data, workspace_hash)` - Formats data to markdown
- `_format_composer_data()` - Formats composer sessions
- `_format_generations()` - Formats AI generations
- `_format_prompts()` - Formats prompts

### 2. `markdown_monitor.py`

**`CursorMarkdownMonitor`** class that:
- Watches database files using `watchdog` (file system events)
- Falls back to polling every 2 minutes (safety net, like example extension)
- Triggers markdown writes when database changes are detected
- Debounces writes (2 second delay after last change)

**Key Features:**
- File watcher for real-time monitoring
- Polling backup (every 2 minutes)
- Debouncing to avoid excessive writes
- Per-workspace markdown writers

## Integration

The markdown monitor is integrated into `server.py`:
- Initialized alongside `CursorDatabaseMonitor`
- Started in a background thread
- Automatically writes markdown when database changes are detected

## Usage

The markdown monitor starts automatically when the telemetry server starts (if cursor monitoring is enabled).

**Output Location:**
- `{workspace}/.history/{workspace_hash}_{timestamp}.md`

**Example Output:**
```markdown
<!-- Generated by Blueplane Telemetry, Markdown v2.0.0 -->
<!-- Workspace: 66b4e47d8cd79622d5b1b18f44882398 -->
<!-- Generated: 2025-01-15 10:30:00 -->

# Composer Sessions

## Composer: a444abdd-2743-4711-b38f-207c8c7427dc

**Created:** 2025-01-15 10:25:14
**Mode:** agent (force: edit)
**Code Changes:** +150 / -50 lines

---

## AI Service Generations

### Generation: dd4317f0-22e0-4153-8f11-9b5aa5fc7946

**Timestamp:** 2025-01-15 10:30:15
**Type:** cmdk
**Description:** User asked about implementing authentication

---
```

## Database Queries

The implementation queries the same keys as the example extension:

```python
TRACE_RELEVANT_KEYS = [
    "aiService.generations",
    "aiService.prompts",
    "composer.composerData",
    "workbench.backgroundComposer.workspacePersistentData",
    "workbench.agentMode.exitInfo",
    "interactive.sessions",
    "history.entries",
    "cursorAuth/workspaceOpenedDate",
]
```

**SQL Query:**
```sql
SELECT key, value FROM ItemTable 
WHERE key IN ('aiService.generations', 'aiService.prompts', ...)
```

## Differences from Example Extension

1. **Conversation Data**: The example extension loads full conversation data from a different source. This implementation focuses on the metadata available in ItemTable.

2. **Tool Usage**: The example extension formats tool usage with special handlers. This implementation includes basic formatting but could be extended.

3. **File Watcher**: Uses Python `watchdog` library instead of `chokidar` (Node.js).

4. **Polling**: Uses 2-minute polling interval (same as example extension's safety net).

## Dependencies

- `aiosqlite` - Async SQLite access (already in requirements.txt)
- `watchdog` - File system watching (optional, falls back to polling if not available)

## Future Enhancements

1. Load full conversation data (if available in other database keys)
2. Format tool usage similar to example extension
3. Add more sophisticated markdown formatting
4. Support for cursorDiskKV table (currently empty)
5. Configurable output directory and format options

